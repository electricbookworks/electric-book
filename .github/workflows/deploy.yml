name: Build and Deploy

on:
  push: # Trigger on any push, but branch validation will filter
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Need full history for proper git operations

    - name: Load deployment configuration
      run: |
        # Load environment variables from .github/workflows/.env.deploy
        ENV_FILE=".github/workflows/.env.deploy"
        if [ -f "$ENV_FILE" ]; then
          # Export only lines that contain '=' and don't start with '#'
          export $(grep -E '^[^#]*=' "$ENV_FILE" | xargs)
          echo "DEPLOY_DIR_NAME=${DEPLOY_DIR_NAME}" >> $GITHUB_ENV
          echo "DEPLOY_BRANCHES=${DEPLOY_BRANCHES}" >> $GITHUB_ENV
          echo "DEPLOY_REPO=${DEPLOY_REPO}" >> $GITHUB_ENV
          echo "‚úÖ Loaded deployment configuration:"
          echo "  Directory: ${DEPLOY_DIR_NAME}"
          echo "  Allowed branches: ${DEPLOY_BRANCHES}"
          echo "  Target repo: ${DEPLOY_REPO}"
        else
          echo "‚ùå ERROR: $ENV_FILE file not found"
          exit 1
        fi

    - name: Check if branch is allowed for deployment
      run: |
        CURRENT_BRANCH="${{ github.ref_name }}"
        IFS=',' read -ra ALLOWED <<< "${DEPLOY_BRANCHES}"
        BRANCH_ALLOWED=false
        
        for branch in "${ALLOWED[@]}"; do
          if [[ "${CURRENT_BRANCH}" == "${branch// /}" ]]; then
            BRANCH_ALLOWED=true
            break
          fi
        done
        
        if [[ "${BRANCH_ALLOWED}" == "false" ]]; then
          echo "‚ùå Branch '${CURRENT_BRANCH}' is not in the allowed branches list: ${DEPLOY_BRANCHES}"
          echo "Skipping deployment."
          exit 1
        fi
        
        echo "‚úÖ Branch '${CURRENT_BRANCH}' is allowed for deployment"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true # runs 'bundle install' and caches gems

    - name: Install dependencies
      run: npm run setup

    - name: Build Electric Book
      run: npm run eb -- output --baseurl="${DEPLOY_DIR_NAME}" --dontserve=true --deploy=true

    - name: Clone target repository and determine target branch
      env:
        DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
      run: |
        # Check if token is available
        if [ -z "$DEPLOY_TOKEN" ]; then
          echo "‚ùå ERROR: DEPLOY_TOKEN secret is not set or is empty"
          echo "Please add a GitHub Personal Access Token as DEPLOY_TOKEN in repository secrets"
          exit 1
        fi
        
        echo "‚úÖ DEPLOY_TOKEN is available"
        
        # Clone with token authentication
        git clone "https://${DEPLOY_TOKEN}@github.com/${DEPLOY_REPO}.git" target-repo
        cd target-repo
        
        SOURCE_BRANCH="${{ github.ref_name }}"
        TARGET_BRANCH="${SOURCE_BRANCH}"
        
        # Check if the source branch exists in target repo
        if git show-ref --verify --quiet refs/remotes/origin/${SOURCE_BRANCH}; then
          echo "Using exact branch match: ${SOURCE_BRANCH}"
          git checkout ${SOURCE_BRANCH}
        else
          # Handle master <-> main mapping
          if [[ "${SOURCE_BRANCH}" == "master" ]] && git show-ref --verify --quiet refs/remotes/origin/main; then
            echo "Source is master, but target repo has main. Using main branch."
            TARGET_BRANCH="main"
            git checkout main
          elif [[ "${SOURCE_BRANCH}" == "main" ]] && git show-ref --verify --quiet refs/remotes/origin/master; then
            echo "Source is main, but target repo has master. Using master branch."
            TARGET_BRANCH="master"
            git checkout master
          else
            echo "Creating new branch: ${SOURCE_BRANCH}"
            git checkout -b ${SOURCE_BRANCH}
          fi
        fi
        
        # Save the target branch name for later steps
        echo "TARGET_BRANCH=${TARGET_BRANCH}" >> $GITHUB_ENV

    - name: Deploy to target repository
      env:
        DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
      run: |
        cd target-repo
        
        # Configure git to use the token for authentication
        git config url."https://${DEPLOY_TOKEN}@github.com/".insteadOf "https://github.com/"
        
        # Use the DEPLOY_DIR_NAME from environment
        echo "üìÇ Deploying to directory: ${DEPLOY_DIR_NAME}"
        
        # Remove existing folder if it exists
        rm -rf public/${DEPLOY_DIR_NAME}
        
        # Create public directory if it doesn't exist
        mkdir -p public
        
        # Copy the built site to the public directory
        cp -r ../_site/${DEPLOY_DIR_NAME} public/
        
        # Remove any .gitignore files from the copied content that might prevent tracking
        find public/${DEPLOY_DIR_NAME} -name ".gitignore" -delete
        
        # Configure git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Add changes and commit (force add to override any gitignore rules)
        git add . --force
        
        # Check if there are any changes to commit
        if git diff --staged --quiet; then
          echo "No changes to deploy"
          exit 0
        fi
        
        git commit -m "Deploy from ${{ github.ref_name }} on ${{ github.repository }}" -m "${{ github.event.head_commit.message }}"
        git push origin ${TARGET_BRANCH}

    - name: Deployment Summary
      run: |
        echo "‚úÖ Successfully deployed to ${DEPLOY_REPO}"
        echo "üìÅ Source branch: ${{ github.ref_name }}"
        echo "üìÅ Target branch: ${TARGET_BRANCH}"
        echo "üìÇ Deployed folder: ${DEPLOY_DIR_NAME}"
        echo "üîó Target repository: ${DEPLOY_REPO}"